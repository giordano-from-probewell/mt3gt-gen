#include "application.h"

#include <stdint.h>
#include <stdbool.h>
#include <stdio.h>
#include <file.h>
#include "F28x_Project.h"






#ifdef CPU1
#include "app_cpu1.h"
#elif defined(CPU2)
#include "app_cpu2.h"
#endif


#pragma DATA_SECTION(fw_info,"fw_info");
const fw_data_t fw_info =
{
 .fw_crc = 0x12345678,
 .version = {"00.01dev"},
 .compilation_date = __DATE__,
 .compilation_time = __TIME__,
#ifdef CPU1
 .cpu = '1',
#elif defined(CPU2)
 .cpu = '2',
#else
 .cpu = '-',
#endif
};



#pragma DATA_SECTION(sm_cpu2, "app_data_cpu2");
app_sm_t sm_cpu2;
#pragma DATA_SECTION(app, "app_data_cpu1");
application_t app;

#pragma DATA_SECTION(refVoltage1,"ref_data");
float32_t refVoltage1[REF_GEN_MAX_SIZE];
#pragma DATA_SECTION(refVoltage2,"ref_data");
float32_t refVoltage2[REF_GEN_MAX_SIZE];
#pragma DATA_SECTION(refCurrent1,"ref_data");
float32_t refCurrent1[REF_GEN_MAX_SIZE];
#pragma DATA_SECTION(refCurrent2,"ref_data");
float32_t refCurrent2[REF_GEN_MAX_SIZE];



#ifdef CPU1

bool flag_new_range = false;
int8_t new_range = 0;

bool flag_new_calibration = false;
int8_t new_cal_parameter = 0;
int8_t new_cal_phase = 0;
int8_t new_cal_index = 0;

bool flag_start_test = false;
bool flag_reset_test = false;
bool flag_reset_metrics = false;

static void ipc_sync_cpu1(void)
{

    IpcRegs.IPCCLR.all = 0xFFFFFFFFUL;
    IpcRegs.IPCSET.bit.IPC0 = 1;
    while (IpcRegs.IPCSTS.bit.IPC0 == 0) {}
    IpcRegs.IPCCLR.bit.IPC0 = 1;
}


static inline void init_abi(application_t *a) {
    a->abi.magic   = ABI_MAGIC;
    a->abi.version = ABI_VERSION;
    a->abi.size    = (uint32_t)sizeof(*a);
    // barrier
    __asm(" RPT #3 || NOP");

}


#elif defined(CPU2)

const float32_t sinus[1000] = { 0.006283, 0.012566039883353, 0.018848439715408, 0.025130095443337, 0.031410759078128, 0.037690182669935, 0.043968118317865, 0.050244318179770, 0.056518534482025, 0.062790519529313, 0.069060025714406, 0.075326805527933, 0.081590611568158, 0.087851196550743, 0.094108313318514, 0.100361714851215, 0.106611154275260, 0.112856384873482, 0.119097160094870, 0.125333233564304, 0.131564359092283, 0.137790290684638, 0.144010782552252, 0.150225589120757, 0.156434465040231, 0.162637165194884, 0.168833444712734, 0.175023058975276, 0.181205763627137, 0.187381314585725, 0.193549468050860, 0.199709980514407, 0.205862608769881, 0.212007109922055, 0.218143241396543, 0.224270760949381, 0.230389426676591, 0.236498997023725, 0.242599230795407, 0.248689887164855, 0.254770725683382, 0.260841506289897, 0.266901989320376, 0.272951935517325, 0.278991106039229, 0.285019262469976, 0.291036166828272, 0.297041581577035, 0.303035269632774, 0.309016994374947, 0.314986519655305, 0.320943609807210, 0.326888029654943, 0.332819544522987, 0.338737920245291, 0.344642923174517, 0.350534320191259, 0.356411878713251, 0.362275366704546, 0.368124552684678, 0.373959205737800, 0.379779095521801, 0.385583992277397, 0.391373666837202, 0.397147890634781, 0.402906435713663, 0.408649074736349, 0.414375580993284, 0.420085728411806, 0.425779291565073, 0.431456045680959, 0.437115766650933, 0.442758231038902, 0.448383216090032, 0.453990499739547, 0.459579860621488, 0.465151078077458, 0.470703932165333, 0.476238203667939, 0.481753674101715, 0.487250125725332, 0.492727341548292, 0.498185105339491, 0.503623201635761, 0.509041415750371, 0.514439533781506, 0.519817342620710, 0.525174629961296, 0.530511184306734, 0.535826794978997, 0.541121252126876, 0.546394346734269, 0.551645870628430, 0.556875616488188, 0.562083377852131, 0.567268949126757, 0.572432125594591, 0.577572703422268, 0.582690479668576, 0.587785252292473, 0.592856820161059, 0.597904983057519, 0.602929541689025, 0.607930297694605, 0.612907053652976, 0.617859613090334, 0.622787780488113, 0.627691361290700, 0.632570161913124, 0.637423989748690, 0.642252653176584, 0.647055961569444, 0.651833725300879, 0.656585755752957, 0.661311865323652, 0.666011867434252, 0.670685576536720, 0.675332808121024, 0.679953378722419, 0.684547105928689, 0.689113808387348, 0.693653305812805, 0.698165418993473, 0.702649969798849, 0.707106781186547, 0.711535677209285, 0.715936483021831, 0.720309024887907, 0.724653130187047, 0.728968627421412, 0.733255346222560, 0.737513117358174, 0.741741772738739, 0.745941145424182, 0.750111069630460, 0.754251380736104, 0.758361915288722, 0.762442511011448, 0.766493006809350, 0.770513242775789, 0.774503060198734, 0.778462301567023, 0.782390810576588, 0.786288432136619, 0.790155012375690, 0.793990398647835, 0.797794439538571, 0.801566984870877, 0.805307885711122, 0.809016994374947, 0.812694164433094, 0.816339250717184, 0.819952109325452, 0.823532597628427, 0.827080574274562, 0.830595899195813, 0.834078433613171, 0.837528040042142, 0.840944582298169, 0.844327925502015, 0.847677936085083, 0.850994481794692, 0.854277431699295, 0.857526656193652, 0.860742027003944, 0.863923417192835, 0.867070701164490, 0.870183754669526, 0.873262454809920, 0.876306680043864, 0.879316310190556, 0.882291226434953, 0.885231311332455, 0.888136448813545, 0.891006524188368, 0.893841424151264, 0.896641036785236, 0.899405251566371, 0.902133959368203, 0.904827052466020, 0.907484424541117, 0.910105970684996, 0.912691587403503, 0.915241172620918, 0.917754625683981, 0.920231847365870, 0.922672739870115, 0.925077206834458, 0.927445153334661, 0.929776485888251, 0.932071112458211, 0.934328942456612, 0.936549886748192, 0.938733857653874, 0.940880768954225, 0.942990535892864, 0.945063075179805, 0.947098304994744, 0.949096144990295, 0.951056516295154, 0.952979341517219, 0.954864544746643, 0.956712051558831, 0.958521789017376, 0.960293685676943, 0.962027671586086, 0.963723678290010, 0.965381638833274, 0.967001487762435, 0.968583161128631, 0.970126596490106, 0.971631732914674, 0.973098510982127, 0.974526872786577, 0.975916761938747, 0.977268123568193, 0.978580904325472, 0.979855052384247, 0.981090517443334, 0.982287250728689, 0.983445204995330, 0.984564334529205, 0.985644595148998, 0.986685944207868, 0.987688340595138, 0.988651744737914, 0.989576118602651, 0.990461425696651, 0.991307631069507, 0.992114701314478, 0.992882604569814, 0.993611310520008, 0.994300790396999, 0.994951016981300, 0.995561964603080, 0.996133609143173, 0.996665928034030, 0.997158900260614, 0.997612506361225, 0.998026728428272, 0.998401550108975, 0.998736956606017, 0.999032934678125, 0.999289472640589, 0.999506560365732, 0.999684189283300, 0.999822352380809, 0.999921044203816, 0.999980260856137, 1.000000000000000, 0.999980260856137, 0.999921044203816, 0.999822352380809, 0.999684189283300, 0.999506560365732, 0.999289472640589, 0.999032934678125, 0.998736956606017, 0.998401550108975, 0.998026728428272, 0.997612506361225, 0.997158900260614, 0.996665928034030, 0.996133609143173, 0.995561964603080, 0.994951016981300, 0.994300790396999, 0.993611310520008, 0.992882604569814, 0.992114701314478, 0.991307631069507, 0.990461425696651, 0.989576118602651, 0.988651744737914, 0.987688340595138, 0.986685944207868, 0.985644595148998, 0.984564334529205, 0.983445204995330, 0.982287250728689, 0.981090517443334, 0.979855052384247, 0.978580904325472, 0.977268123568193, 0.975916761938747, 0.974526872786577, 0.973098510982127, 0.971631732914674, 0.970126596490106, 0.968583161128631, 0.967001487762435, 0.965381638833274, 0.963723678290010, 0.962027671586086, 0.960293685676943, 0.958521789017376, 0.956712051558831, 0.954864544746643, 0.952979341517219, 0.951056516295154, 0.949096144990295, 0.947098304994744, 0.945063075179805, 0.942990535892865, 0.940880768954225, 0.938733857653874, 0.936549886748192, 0.934328942456612, 0.932071112458211, 0.929776485888251, 0.927445153334661, 0.925077206834458, 0.922672739870115, 0.920231847365870, 0.917754625683981, 0.915241172620918, 0.912691587403503, 0.910105970684996, 0.907484424541117, 0.904827052466019, 0.902133959368203, 0.899405251566371, 0.896641036785236, 0.893841424151264, 0.891006524188368, 0.888136448813545, 0.885231311332455, 0.882291226434953, 0.879316310190556, 0.876306680043863, 0.873262454809920, 0.870183754669526, 0.867070701164490, 0.863923417192835, 0.860742027003944, 0.857526656193652, 0.854277431699295, 0.850994481794692, 0.847677936085083, 0.844327925502015, 0.840944582298169, 0.837528040042142, 0.834078433613171, 0.830595899195813, 0.827080574274562, 0.823532597628427, 0.819952109325452, 0.816339250717184, 0.812694164433094, 0.809016994374947, 0.805307885711122, 0.801566984870877, 0.797794439538571, 0.793990398647835, 0.790155012375691, 0.786288432136619, 0.782390810576588, 0.778462301567023, 0.774503060198734, 0.770513242775789, 0.766493006809350, 0.762442511011448, 0.758361915288722, 0.754251380736104, 0.750111069630460, 0.745941145424182, 0.741741772738739, 0.737513117358174, 0.733255346222560, 0.728968627421411, 0.724653130187047, 0.720309024887907, 0.715936483021831, 0.711535677209285, 0.707106781186548, 0.702649969798849, 0.698165418993473, 0.693653305812805, 0.689113808387348, 0.684547105928689, 0.679953378722419, 0.675332808121025, 0.670685576536720, 0.666011867434252, 0.661311865323652, 0.656585755752956, 0.651833725300879, 0.647055961569444, 0.642252653176585, 0.637423989748690, 0.632570161913125, 0.627691361290701, 0.622787780488113, 0.617859613090334, 0.612907053652976, 0.607930297694605, 0.602929541689025, 0.597904983057519, 0.592856820161059, 0.587785252292473, 0.582690479668576, 0.577572703422268, 0.572432125594591, 0.567268949126756, 0.562083377852130, 0.556875616488188, 0.551645870628430, 0.546394346734269, 0.541121252126876, 0.535826794978997, 0.530511184306734, 0.525174629961296, 0.519817342620709, 0.514439533781506, 0.509041415750371, 0.503623201635761, 0.498185105339491, 0.492727341548292, 0.487250125725333, 0.481753674101716, 0.476238203667939, 0.470703932165333, 0.465151078077459, 0.459579860621488, 0.453990499739547, 0.448383216090032, 0.442758231038902, 0.437115766650933, 0.431456045680959, 0.425779291565073, 0.420085728411806, 0.414375580993284, 0.408649074736349, 0.402906435713663, 0.397147890634781, 0.391373666837202, 0.385583992277396, 0.379779095521801, 0.373959205737801, 0.368124552684678, 0.362275366704546, 0.356411878713251, 0.350534320191259, 0.344642923174517, 0.338737920245291, 0.332819544522987, 0.326888029654943, 0.320943609807210, 0.314986519655305, 0.309016994374948, 0.303035269632774, 0.297041581577035, 0.291036166828272, 0.285019262469976, 0.278991106039229, 0.272951935517325, 0.266901989320376, 0.260841506289897, 0.254770725683382, 0.248689887164855, 0.242599230795407, 0.236498997023725, 0.230389426676590, 0.224270760949381, 0.218143241396542, 0.212007109922055, 0.205862608769881, 0.199709980514407, 0.193549468050860, 0.187381314585725, 0.181205763627137, 0.175023058975276, 0.168833444712734, 0.162637165194883, 0.156434465040231, 0.150225589120757, 0.144010782552252, 0.137790290684638, 0.131564359092282, 0.125333233564304, 0.119097160094870, 0.112856384873482, 0.106611154275260, 0.100361714851215, 0.094108313318514, 0.087851196550743, 0.081590611568158, 0.075326805527933, 0.069060025714406, 0.062790519529314, 0.056518534482025, 0.050244318179770, 0.043968118317865, 0.037690182669935, 0.031410759078128, 0.025130095443338, 0.018848439715408, 0.012566039883353, 0.006283143965559, 0.000000000000000, -0.006283143965559, -0.012566039883353, -0.018848439715408, -0.025130095443338, -0.031410759078128, -0.037690182669934, -0.043968118317865, -0.050244318179769, -0.056518534482024, -0.062790519529313, -0.069060025714406, -0.075326805527933, -0.081590611568158, -0.087851196550743, -0.094108313318514, -0.100361714851215, -0.106611154275260, -0.112856384873482, -0.119097160094870, -0.125333233564304, -0.131564359092283, -0.137790290684638, -0.144010782552252, -0.150225589120757, -0.156434465040231, -0.162637165194884, -0.168833444712734, -0.175023058975276, -0.181205763627137, -0.187381314585725, -0.193549468050860, -0.199709980514407, -0.205862608769881, -0.212007109922055, -0.218143241396543, -0.224270760949381, -0.230389426676591, -0.236498997023725, -0.242599230795408, -0.248689887164855, -0.254770725683382, -0.260841506289897, -0.266901989320376, -0.272951935517325, -0.278991106039229, -0.285019262469976, -0.291036166828272, -0.297041581577035, -0.303035269632774, -0.309016994374948, -0.314986519655305, -0.320943609807209, -0.326888029654943, -0.332819544522987, -0.338737920245291, -0.344642923174517, -0.350534320191259, -0.356411878713251, -0.362275366704546, -0.368124552684678, -0.373959205737800, -0.379779095521801, -0.385583992277397, -0.391373666837203, -0.397147890634781, -0.402906435713663, -0.408649074736349, -0.414375580993284, -0.420085728411807, -0.425779291565073, -0.431456045680959, -0.437115766650933, -0.442758231038902, -0.448383216090032, -0.453990499739547, -0.459579860621488, -0.465151078077459, -0.470703932165332, -0.476238203667939, -0.481753674101715, -0.487250125725332, -0.492727341548291, -0.498185105339491, -0.503623201635760, -0.509041415750371, -0.514439533781506, -0.519817342620709, -0.525174629961295, -0.530511184306734, -0.535826794978996, -0.541121252126876, -0.546394346734269, -0.551645870628430, -0.556875616488188, -0.562083377852130, -0.567268949126756, -0.572432125594591, -0.577572703422267, -0.582690479668576, -0.587785252292473, -0.592856820161059, -0.597904983057518, -0.602929541689024, -0.607930297694605, -0.612907053652976, -0.617859613090334, -0.622787780488112, -0.627691361290700, -0.632570161913124, -0.637423989748690, -0.642252653176584, -0.647055961569444, -0.651833725300878, -0.656585755752956, -0.661311865323652, -0.666011867434251, -0.670685576536720, -0.675332808121024, -0.679953378722419, -0.684547105928689, -0.689113808387348, -0.693653305812805, -0.698165418993473, -0.702649969798849, -0.707106781186547, -0.711535677209285, -0.715936483021831, -0.720309024887907, -0.724653130187047, -0.728968627421411, -0.733255346222560, -0.737513117358174, -0.741741772738739, -0.745941145424182, -0.750111069630459, -0.754251380736104, -0.758361915288722, -0.762442511011448, -0.766493006809350, -0.770513242775789, -0.774503060198734, -0.778462301567024, -0.782390810576588, -0.786288432136619, -0.790155012375690, -0.793990398647835, -0.797794439538571, -0.801566984870876, -0.805307885711122, -0.809016994374947, -0.812694164433094, -0.816339250717184, -0.819952109325452, -0.823532597628427, -0.827080574274562, -0.830595899195813, -0.834078433613171, -0.837528040042142, -0.840944582298169, -0.844327925502015, -0.847677936085083, -0.850994481794692, -0.854277431699295, -0.857526656193652, -0.860742027003944, -0.863923417192835, -0.867070701164490, -0.870183754669526, -0.873262454809920, -0.876306680043864, -0.879316310190556, -0.882291226434953, -0.885231311332455, -0.888136448813545, -0.891006524188368, -0.893841424151264, -0.896641036785236, -0.899405251566371, -0.902133959368203, -0.904827052466020, -0.907484424541117, -0.910105970684996, -0.912691587403503, -0.915241172620918, -0.917754625683981, -0.920231847365870, -0.922672739870115, -0.925077206834458, -0.927445153334661, -0.929776485888251, -0.932071112458211, -0.934328942456612, -0.936549886748192, -0.938733857653874, -0.940880768954225, -0.942990535892865, -0.945063075179805, -0.947098304994744, -0.949096144990295, -0.951056516295154, -0.952979341517219, -0.954864544746643, -0.956712051558831, -0.958521789017376, -0.960293685676943, -0.962027671586086, -0.963723678290010, -0.965381638833274, -0.967001487762435, -0.968583161128631, -0.970126596490106, -0.971631732914674, -0.973098510982126, -0.974526872786577, -0.975916761938747, -0.977268123568193, -0.978580904325472, -0.979855052384247, -0.981090517443334, -0.982287250728689, -0.983445204995330, -0.984564334529205, -0.985644595148998, -0.986685944207868, -0.987688340595138, -0.988651744737914, -0.989576118602651, -0.990461425696651, -0.991307631069507, -0.992114701314478, -0.992882604569814, -0.993611310520008, -0.994300790396999, -0.994951016981300, -0.995561964603080, -0.996133609143173, -0.996665928034030, -0.997158900260614, -0.997612506361225, -0.998026728428272, -0.998401550108975, -0.998736956606017, -0.999032934678125, -0.999289472640589, -0.999506560365732, -0.999684189283300, -0.999822352380809, -0.999921044203816, -0.999980260856137, -1.000000000000000, -0.999980260856137, -0.999921044203816, -0.999822352380809, -0.999684189283300, -0.999506560365732, -0.999289472640589, -0.999032934678125, -0.998736956606017, -0.998401550108975, -0.998026728428272, -0.997612506361225, -0.997158900260614, -0.996665928034030, -0.996133609143173, -0.995561964603080, -0.994951016981300, -0.994300790396999, -0.993611310520008, -0.992882604569814, -0.992114701314478, -0.991307631069507, -0.990461425696651, -0.989576118602651, -0.988651744737914, -0.987688340595138, -0.986685944207868, -0.985644595148998, -0.984564334529205, -0.983445204995330, -0.982287250728689, -0.981090517443334, -0.979855052384247, -0.978580904325472, -0.977268123568193, -0.975916761938747, -0.974526872786577, -0.973098510982126, -0.971631732914674, -0.970126596490106, -0.968583161128631, -0.967001487762435, -0.965381638833274, -0.963723678290010, -0.962027671586086, -0.960293685676943, -0.958521789017376, -0.956712051558830, -0.954864544746643, -0.952979341517219, -0.951056516295154, -0.949096144990294, -0.947098304994744, -0.945063075179805, -0.942990535892864, -0.940880768954225, -0.938733857653874, -0.936549886748192, -0.934328942456612, -0.932071112458211, -0.929776485888251, -0.927445153334661, -0.925077206834458, -0.922672739870115, -0.920231847365870, -0.917754625683981, -0.915241172620918, -0.912691587403503, -0.910105970684996, -0.907484424541117, -0.904827052466020, -0.902133959368203, -0.899405251566371, -0.896641036785236, -0.893841424151264, -0.891006524188368, -0.888136448813544, -0.885231311332455, -0.882291226434953, -0.879316310190556, -0.876306680043863, -0.873262454809920, -0.870183754669525, -0.867070701164490, -0.863923417192835, -0.860742027003944, -0.857526656193652, -0.854277431699295, -0.850994481794692, -0.847677936085083, -0.844327925502016, -0.840944582298169, -0.837528040042142, -0.834078433613171, -0.830595899195813, -0.827080574274562, -0.823532597628428, -0.819952109325452, -0.816339250717184, -0.812694164433094, -0.809016994374948, -0.805307885711122, -0.801566984870877, -0.797794439538571, -0.793990398647835, -0.790155012375691, -0.786288432136619, -0.782390810576588, -0.778462301567024, -0.774503060198734, -0.770513242775790, -0.766493006809350, -0.762442511011448, -0.758361915288722, -0.754251380736104, -0.750111069630459, -0.745941145424182, -0.741741772738740, -0.737513117358174, -0.733255346222560, -0.728968627421412, -0.724653130187047, -0.720309024887907, -0.715936483021831, -0.711535677209285, -0.707106781186548, -0.702649969798850, -0.698165418993473, -0.693653305812805, -0.689113808387348, -0.684547105928689, -0.679953378722419, -0.675332808121025, -0.670685576536720, -0.666011867434252, -0.661311865323652, -0.656585755752957, -0.651833725300879, -0.647055961569444, -0.642252653176585, -0.637423989748690, -0.632570161913125, -0.627691361290700, -0.622787780488113, -0.617859613090335, -0.612907053652976, -0.607930297694606, -0.602929541689025, -0.597904983057519, -0.592856820161059, -0.587785252292473, -0.582690479668576, -0.577572703422268, -0.572432125594591, -0.567268949126757, -0.562083377852131, -0.556875616488188, -0.551645870628431, -0.546394346734269, -0.541121252126876, -0.535826794978996, -0.530511184306734, -0.525174629961295, -0.519817342620709, -0.514439533781507, -0.509041415750371, -0.503623201635761, -0.498185105339491, -0.492727341548292, -0.487250125725332, -0.481753674101715, -0.476238203667939, -0.470703932165333, -0.465151078077459, -0.459579860621488, -0.453990499739547, -0.448383216090032, -0.442758231038902, -0.437115766650933, -0.431456045680959, -0.425779291565072, -0.420085728411806, -0.414375580993284, -0.408649074736349, -0.402906435713663, -0.397147890634780, -0.391373666837202, -0.385583992277396, -0.379779095521801, -0.373959205737800, -0.368124552684678, -0.362275366704546, -0.356411878713250, -0.350534320191259, -0.344642923174517, -0.338737920245291, -0.332819544522986, -0.326888029654942, -0.320943609807209, -0.314986519655305, -0.309016994374948, -0.303035269632774, -0.297041581577035, -0.291036166828271, -0.285019262469976, -0.278991106039229, -0.272951935517325, -0.266901989320375, -0.260841506289897, -0.254770725683382, -0.248689887164854, -0.242599230795408, -0.236498997023725, -0.230389426676591, -0.224270760949382, -0.218143241396543, -0.212007109922055, -0.205862608769882, -0.199709980514407, -0.193549468050861, -0.187381314585725, -0.181205763627138, -0.175023058975276, -0.168833444712734, -0.162637165194884, -0.156434465040231, -0.150225589120758, -0.144010782552252, -0.137790290684639, -0.131564359092283, -0.125333233564305, -0.119097160094870, -0.112856384873482, -0.106611154275261, -0.100361714851215, -0.094108313318515, -0.087851196550743, -0.081590611568158, -0.075326805527933, -0.069060025714406, -0.062790519529313, -0.056518534482025, -0.050244318179770, -0.043968118317865, -0.037690182669935, -0.031410759078128, -0.025130095443338, -0.018848439715408, -0.012566039883353, -0.006283143965559, -0.000000000000000 };


#ifndef APP_ADDR_EXPECT
#define APP_ADDR_EXPECT ((uintptr_t)0x000C000u)  /* from linker file .cmd */
#endif

static void ipc_sync_cpu2(void)
{
    IpcRegs.IPCCLR.all = 0xFFFFFFFFUL;
    while (IpcRegs.IPCSTS.bit.IPC0 == 0) {}
    IpcRegs.IPCSET.bit.IPC0 = 1;


}

static inline bool abi_ready(const application_t *a) {

    // barrier
    __asm(" RPT #3 || NOP");

    return (a->abi.magic   == ABI_MAGIC)   &&
            (a->abi.version == ABI_VERSION) &&
            (a->abi.size    == (uint32_t)sizeof(application_t)) &&
            ((uintptr_t)&app == APP_ADDR_EXPECT);
}

static inline void check_abi(application_t *a) {
    const uint32_t MAX_SPINS = 500000u;
    uint32_t spins = 0u;
    while (!abi_ready(a) && spins++ < MAX_SPINS) {
        __asm(" NOP");
    }
    if (!abi_ready(a)) {

        ESTOP0;
    }
}

#endif



generic_status_t app_init(application_t * app)
{
    generic_status_t ret = STATUS_DONE;

#ifdef CPU1
    {

        init_abi(app);

        app->sm_cpu2 = &sm_cpu2;
        /*ret = */app_init_cpu1(app);

        // Synchronize both the cores
        ipc_sync_cpu1();


    }
#elif defined(CPU2)
    {

        int i;
        // Enable Global Interrupt (INTM) and real time interrupt (DBGM)
        EINT;
        ERTM;

        ipc_sync_cpu2();

        check_abi(app);


        for (i=0;i<REF_GEN_DEFAULT_SIZE;i++)
        {
            refVoltage1[i] = sinus[i];
            refVoltage2[i] = sinus[i];
            refCurrent1[i] = sinus[i];
            refCurrent2[i] = sinus[i];
        }

        /*ret = */app_init_cpu2(app);
    }
#endif
    return ret;
}



generic_status_t app_run(application_t * this_app)
{
    generic_status_t ret = STATUS_DONE;


#ifdef CPU1
    {
        app_run_cpu1(this_app);
    }
#elif defined(CPU2)
    {
        app_run_cpu2(this_app);
    }
#endif

    return ret;
}














